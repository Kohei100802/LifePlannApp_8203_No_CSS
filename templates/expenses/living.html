{% extends "base-new.html" %}

{% block title %}生活費管理{% endblock %}
{% block page_title %}生活費管理{% endblock %}

{% block content %}
<div class="modern-tabs-container">
    <!-- プラン管理コンテンツ -->
    <div class="modern-tab-content active">
        <div class="content-section">
            <!-- 登録済み生活費一覧 -->
            <div id="living-expenses-list">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>
</div>

<!-- フローティングボタン -->
<div class="fab-container" id="fabContainer">
    <a href="/expenses/living/new" class="fab-button add" title="新規追加">
        <i class="material-icons">add</i>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
let livingExpensesData = [];

document.addEventListener('DOMContentLoaded', function() {
    // 生活費データ読み込み
    loadLivingExpenses();
    
    // 選択UIを初期化
    initializeSelectionUI();
});

// 選択UIの初期化
function initializeSelectionUI() {
    window.selectionUI = new SelectionUI({
        onCopy: handleCopy,
        onDelete: handleDelete,
        onEdit: handleEdit,
        onCancel: handleCancel,
        getItemId: (element) => element.dataset.expenseId
    });
}

// コピー処理
async function handleCopy(selectedIds) {
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/living-expenses/${id}/copy`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件の生活費をコピーしました`, 'success');
            loadLivingExpenses();
        } else {
            showToast('生活費のコピーに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error copying living expenses:', error);
        showToast('生活費のコピー中にエラーが発生しました', 'error');
    }
}

// 削除処理
async function handleDelete(selectedIds) {
    const confirmMessage = `選択した${selectedIds.length}件の生活費を削除しますか？`;
    if (!confirm(confirmMessage)) return;
    
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/living-expenses/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件の生活費を削除しました`, 'success');
            loadLivingExpenses();
        } else {
            showToast('生活費の削除に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error deleting living expenses:', error);
        showToast('生活費の削除中にエラーが発生しました', 'error');
    }
}

// 編集処理
async function handleEdit(expenseId) {
    window.location.href = `/expenses/living/edit/${expenseId}`;
}

// キャンセル処理
function handleCancel() {
    // 選択モード終了時の処理
    console.log('Selection mode cancelled');
}

// 生活費データ読み込み
async function loadLivingExpenses() {
    try {
        const livingExpenses = await apiCall('/api/living-expenses');
        livingExpensesData = livingExpenses;
        displayLivingExpenses(livingExpenses);
        
        // 選択UIの表示制御
        if (window.selectionUI) {
            if (livingExpenses.length > 0) {
                window.selectionUI.show();
            } else {
                window.selectionUI.hide();
            }
        }
    } catch (error) {
        console.error('Error loading living expenses:', error);
        showToast('生活費の読み込みに失敗しました', 'error');
    }
}

// 生活費表示
function displayLivingExpenses(livingExpenses) {
    const listContainer = document.getElementById('living-expenses-list');
    
    if (livingExpenses.length === 0) {
        listContainer.innerHTML = `
            <div class="empty-state">
                <div style="text-align: center; padding: 2rem; color: var(--color-secondary);">
                    <i class="material-icons" style="font-size: 3rem; margin-bottom: 1rem;">home</i>
                    <p>登録済みの生活費がありません</p>
                    <p class="text-small">右下の「+」ボタンから作成してください</p>
                </div>
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="modern-menu-grid">
            ${livingExpenses.map(expense => {
                const monthlyTotal = (expense.monthly_total_amount || 0) / 10000;
                const periodText = `${expense.start_year}年-${expense.end_year}年`;
                
                return `
                    <div class="modern-menu-card plan-card" 
                         data-selectable="true" 
                         data-expense-id="${expense.id}"
                         style="position: relative; cursor: pointer; display: flex; align-items: center; min-height: 80px;" 
                         onclick="handleExpenseClick(${expense.id})">
                        <div class="card-content" style="flex: 1;">
                            <h3 class="card-title" style="margin-bottom: 8px; font-size: 1.1em; font-weight: 600;">${expense.name}</h3>
                            <p class="card-description" style="margin-bottom: 0; line-height: 1.4; color: var(--color-text-secondary);">
                                ${periodText}<br>
                                月額 ${monthlyTotal.toFixed(1)}万円
                                ${expense.description ? `<br><span style="color: var(--color-text-secondary); font-size: 0.9em; font-style: italic;">${expense.description}</span>` : ''}
                            </p>
                        </div>
                        <div class="card-arrow" style="color: var(--color-text-secondary); pointer-events: none;">
                            <i class="material-icons" style="font-size: 20px;">arrow_forward_ios</i>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    listContainer.innerHTML = html;
}

// 生活費クリック処理
function handleExpenseClick(expenseId) {
    // 選択モード中はクリックを無効化
    if (window.selectionUI && window.selectionUI.isSelectionMode) {
        return;
    }
    
    window.location.href = `/expenses/living/edit/${expenseId}`;
}
</script>
{% endblock %} 