{% extends "base-new.html" %}

{% block title %}住居費管理{% endblock %}
{% block page_title %}住居費管理{% endblock %}

{% block content %}
<div class="modern-tabs-container">
    <!-- プラン管理コンテンツ -->
    <div class="modern-tab-content active">
        <div class="content-section">
            <!-- 登録済み住居費一覧 -->
            <div id="housing-expenses-list">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>
</div>

<!-- フローティングボタン -->
<div class="fab-container multiple-buttons" id="fabContainer">
    <a href="/expenses/housing/new" class="fab-button add" title="新規追加">
        <i class="material-icons">add</i>
    </a>
    <button id="toolsFab" class="fab-button tools" title="ツール" style="display: none;">
        <i class="material-icons">more_horiz</i>
    </button>
</div>

<!-- ツールメニュー -->
<div id="toolsMenu" class="tools-menu" style="display: none;">
    <div class="tools-menu-content">
        <button id="copyToolBtn" class="tool-menu-item">
            <i class="material-icons">content_copy</i>
            <span>コピー</span>
        </button>
        <button id="deleteToolBtn" class="tool-menu-item">
            <i class="material-icons">delete</i>
            <span>削除</span>
        </button>
    </div>
</div>

<!-- データ選択モーダル -->
<div id="dataSelectionModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">データを選択してください</h3>
            <button class="close-button" onclick="closeDataSelectionModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body">
            <div id="dataSelectionList">
                <!-- 動的に生成 -->
            </div>
        </div>
        <div class="modal-footer" style="padding: 16px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeDataSelectionModal()">キャンセル</button>
            <button id="executeActionBtn" class="btn btn-primary" style="display: none;">実行</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAction = null;
let selectedItems = [];
let housingExpensesData = [];

document.addEventListener('DOMContentLoaded', function() {
    // 住居費データ読み込み
    loadHousingExpenses();
    
    // ツールボタンのイベントリスナー
    setupToolsMenu();
});

// ツールメニューの設定
function setupToolsMenu() {
    const toolsFab = document.getElementById('toolsFab');
    const toolsMenu = document.getElementById('toolsMenu');
    const copyToolBtn = document.getElementById('copyToolBtn');
    const deleteToolBtn = document.getElementById('deleteToolBtn');
    
    // ツールボタンクリック
    toolsFab.addEventListener('click', function(e) {
        e.stopPropagation();
        const isVisible = toolsMenu.style.display !== 'none';
        toolsMenu.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            // メニューの位置を調整
            const fabRect = toolsFab.getBoundingClientRect();
            toolsMenu.style.bottom = (window.innerHeight - fabRect.top + 10) + 'px';
            toolsMenu.style.right = (window.innerWidth - fabRect.right) + 'px';
        }
    });
    
    // コピーボタンクリック
    copyToolBtn.addEventListener('click', function() {
        currentAction = 'copy';
        toolsMenu.style.display = 'none';
        showDataSelectionModal('コピーするデータを選択してください');
    });
    
    // 削除ボタンクリック
    deleteToolBtn.addEventListener('click', function() {
        currentAction = 'delete';
        toolsMenu.style.display = 'none';
        showDataSelectionModal('削除するデータを選択してください');
    });
    
    // 外部クリックでメニューを閉じる
    document.addEventListener('click', function() {
        toolsMenu.style.display = 'none';
    });
    
    toolsMenu.addEventListener('click', function(e) {
        e.stopPropagation();
    });
}

// 住居費データ読み込み
async function loadHousingExpenses() {
    try {
        const housingExpenses = await apiCall('/api/housing-expenses');
        housingExpensesData = housingExpenses; // グローバル変数に保存
        displayHousingExpenses(housingExpenses);
    } catch (error) {
        console.error('Error loading housing expenses:', error);
        showToast('住居費の読み込みに失敗しました', 'error');
    }
}

// 住居費表示
function displayHousingExpenses(housingExpenses) {
    const listContainer = document.getElementById('housing-expenses-list');
    const toolsFab = document.getElementById('toolsFab');
    const fabContainer = document.getElementById('fabContainer');
    
    if (housingExpenses.length === 0) {
        listContainer.innerHTML = `
            <div class="empty-state">
                <div style="text-align: center; padding: 2rem; color: var(--color-secondary);">
                    <i class="material-icons" style="font-size: 3rem; margin-bottom: 1rem;">apartment</i>
                    <p>登録済みの住居費がありません</p>
                    <p class="text-small">右下の「+」ボタンから作成してください</p>
                </div>
            </div>
        `;
        // データがない場合はツールボタンを非表示
        if (toolsFab) {
            toolsFab.style.display = 'none';
        }
        // multiple-buttonsクラスを削除
        if (fabContainer) {
            fabContainer.classList.remove('multiple-buttons');
        }
        return;
    }
    
    // データがある場合はツールボタンを表示
    if (toolsFab) {
        toolsFab.style.display = 'inline-flex';
    }
    // multiple-buttonsクラスを追加
    if (fabContainer) {
        fabContainer.classList.add('multiple-buttons');
    }
    
    const html = `
        <div class="modern-menu-grid">
            ${housingExpenses.map(expense => {
                const monthlyAmount = (expense.monthly_amount || 0) / 10000;
                const annualTotal = monthlyAmount * 12;
                const periodText = `${expense.start_year}年-${expense.end_year}年`;
                const housingTypeText = expense.housing_type === 'rent' ? '賃貸' : 
                                       expense.housing_type === 'owned' ? '持ち家' : 
                                       expense.housing_type === 'loan' ? 'ローン' : '';
        
        return `
                    <div class="modern-menu-card plan-card" style="position: relative; cursor: pointer; display: flex; align-items: center; min-height: 80px;" onclick="showExpenseDetails(${expense.id})">
                        <div class="plan-actions" style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; z-index: 10;" onclick="event.stopPropagation();">
                            <button onclick="copyExpense(${expense.id})" class="plan-action-btn" title="コピー" style="background: #FF9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; border: none; cursor: pointer; min-width: 50px; height: 28px;">
                                <i class="material-icons" style="font-size: 14px; margin-right: 2px;">content_copy</i>コピー
                            </button>
                            <button onclick="deleteHousingExpense(${expense.id})" class="plan-action-btn" title="削除" style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; border: none; cursor: pointer; min-width: 50px; height: 28px;">
                                <i class="material-icons" style="font-size: 14px; margin-right: 2px;">delete</i>削除
                            </button>
                        </div>
                        <div class="card-content" style="flex: 1; padding-right: 140px;">
                            <h3 class="card-title" style="margin-bottom: 8px; font-size: 1.1em; font-weight: 600;">${expense.name}</h3>
                            <p class="card-description" style="margin-bottom: 0; line-height: 1.4; color: var(--color-text-secondary);">
                                ${periodText} | ${housingTypeText}<br>
                                月額 ${monthlyAmount.toFixed(1)}万円 | 年額 ${annualTotal.toFixed(1)}万円
                                ${expense.description ? `<br><span style="color: var(--color-text-secondary); font-size: 0.9em; font-style: italic;">${expense.description}</span>` : ''}
                            </p>
                        </div>
                        <div class="card-arrow" style="position: absolute; right: 12px; bottom: 12px; color: var(--color-text-secondary); pointer-events: none;">
                            <i class="material-icons" style="font-size: 20px;">arrow_forward_ios</i>
                        </div>
                    </div>
                `;
            }).join('')}
            </div>
        `;
    
    listContainer.innerHTML = html;
}

// 住居費詳細表示（カードクリック時）
function showExpenseDetails(expenseId) {
    // 編集ページに遷移
    window.location.href = `/expenses/housing/edit/${expenseId}`;
}

// 住居費削除
async function deleteHousingExpense(expenseId) {
    if (!confirm('この住居費を削除しますか？')) return;
    
    try {
        const response = await fetch(`/api/housing-expenses/${expenseId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('住居費を削除しました', 'success');
            loadHousingExpenses(); // 一覧を再読み込み
        } else {
            showToast('住居費の削除に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error deleting housing expense:', error);
        showToast('住居費の削除に失敗しました', 'error');
    }
}

// 住居費コピー
async function copyExpense(expenseId) {
    try {
        const response = await fetch(`/api/housing-expenses/${expenseId}/copy`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('住居費をコピーしました', 'success');
            loadHousingExpenses(); // 一覧を再読み込み
        } else {
            showToast('住居費のコピーに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error copying housing expense:', error);
        showToast('住居費のコピーに失敗しました', 'error');
    }
}

// データ選択モーダルを表示
function showDataSelectionModal(title) {
    if (housingExpensesData.length === 0) {
        showToast('選択できるデータがありません', 'warning');
        return;
    }
    
    const modal = document.getElementById('dataSelectionModal');
    const modalTitle = document.getElementById('modalTitle');
    const dataList = document.getElementById('dataSelectionList');
    const executeBtn = document.getElementById('executeActionBtn');
    
    modalTitle.textContent = title;
    selectedItems = [];
    
    // データリストを生成
    let html = '<div class="data-selection-list">';
    housingExpensesData.forEach(expense => {
        const monthlyAmount = (expense.monthly_amount || 0) / 10000;
        const periodText = `${expense.start_year}年-${expense.end_year}年`;
        const housingTypeText = expense.housing_type === 'rent' ? '賃貸' : 
                               expense.housing_type === 'owned' ? '持ち家' : 
                               expense.housing_type === 'loan' ? 'ローン' : '';
        
        html += `
            <label class="data-selection-item">
                <input type="checkbox" value="${expense.id}" onchange="updateSelectedItems()">
                <div class="selection-item-content">
                    <div class="selection-item-title">${expense.name}</div>
                    <div class="selection-item-details">
                        ${periodText} | ${housingTypeText} | 月額 ${monthlyAmount.toFixed(1)}万円
                        ${expense.description ? `<br><span style="color: #666; font-size: 0.9em;">${expense.description}</span>` : ''}
                    </div>
                </div>
            </label>
        `;
    });
    html += '</div>';
    
    dataList.innerHTML = html;
    executeBtn.style.display = 'none';
    executeBtn.textContent = currentAction === 'copy' ? 'コピー' : '削除';
    executeBtn.onclick = executeSelectedAction;
    
    modal.classList.add('show');
}

// 選択項目の更新
function updateSelectedItems() {
    const checkboxes = document.querySelectorAll('#dataSelectionList input[type="checkbox"]:checked');
    selectedItems = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    const executeBtn = document.getElementById('executeActionBtn');
    executeBtn.style.display = selectedItems.length > 0 ? 'block' : 'none';
}

// データ選択モーダルを閉じる
function closeDataSelectionModal() {
    const modal = document.getElementById('dataSelectionModal');
    modal.classList.remove('show');
    selectedItems = [];
}

// 選択したアクションを実行
async function executeSelectedAction() {
    if (selectedItems.length === 0) return;
    
    const actionText = currentAction === 'copy' ? 'コピー' : '削除';
    const confirmMessage = `選択した${selectedItems.length}件のデータを${actionText}しますか？`;
    
    if (!confirm(confirmMessage)) return;
    
    try {
        let successCount = 0;
        
        for (const id of selectedItems) {
            let success = false;
            
            if (currentAction === 'copy') {
                const response = await fetch(`/api/housing-expenses/${id}/copy`, {
                    method: 'POST'
                });
                const result = await response.json();
                success = result.success;
            } else if (currentAction === 'delete') {
                const response = await fetch(`/api/housing-expenses/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                success = result.success;
            }
            
            if (success) successCount++;
        }
        
        closeDataSelectionModal();
        
        if (successCount === selectedItems.length) {
            showToast(`${successCount}件のデータを${actionText}しました`, 'success');
        } else {
            showToast(`${successCount}/${selectedItems.length}件のデータを${actionText}しました`, 'warning');
        }
        
        loadHousingExpenses(); // 一覧を再読み込み
        
    } catch (error) {
        console.error(`Error executing ${currentAction}:`, error);
        showToast(`${actionText}の実行に失敗しました`, 'error');
    }
}
</script>
{% endblock %} 