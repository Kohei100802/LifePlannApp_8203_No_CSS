{% extends "base-new.html" %}

{% block title %}シミュレーション{% endblock %}
{% block page_title %}ライフプランシミュレーション{% endblock %}

{% block head %}
<!-- Chart.js (ローカル版) -->
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
{% endblock %}

{% block content %}
<div class="modern-tabs-container simulation-page">
    <!-- プラン管理コンテンツ -->
    <div class="modern-tab-content active">
        <div class="content-section">
            <!-- 登録済みプラン一覧 -->
            <div id="planList">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>
</div>

<!-- フローティングボタン -->
<div class="fab-container multiple-buttons" id="fabContainer">
    <a href="/simulation/create" class="fab-button add" title="新規プラン作成">
        <i class="material-icons">add</i>
    </a>
</div>

<!-- データ登録案内 -->
<div id="noDataMessage" class="modern-tabs-container simulation-page hidden">
    <div class="modern-tab-navigation">
        <div class="modern-tab-item active" style="cursor: default;">
            <div class="tab-icon-wrapper">
                <i class="material-icons">info</i>
            </div>
            <div class="tab-content-wrapper">
                <span class="tab-title">データ不足</span>
                <span class="tab-description">シミュレーション実行にはデータ登録が必要です</span>
            </div>
            <div class="tab-indicator"></div>
        </div>
    </div>
    <div class="modern-tab-content active">
        <div class="content-section">
            <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                <div style="font-size: 3rem; margin-bottom: 16px; color: var(--color-secondary);">
                    <i class="material-icons" style="font-size: 3rem;">assessment</i>
                </div>
                <h3 style="margin-bottom: 16px;">データが不足しています</h3>
                <p class="text-secondary" style="margin-bottom: 24px;">
                    シミュレーションを実行するには、事前に支出・収入データの登録が必要です。<br>
                    下記のボタンから各種データを登録してください。
                </p>
            </div>
            <div class="modern-menu-grid">
                <a href="/expenses/incomes" class="modern-menu-card">
                    <div class="card-icon expenses-icon">
                        <i class="material-icons">account_balance_wallet</i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">支出データ登録</h3>
                        <p class="card-description">生活費、住居費、教育費などを登録</p>
                    </div>
                    <div class="card-arrow">
                        <i class="material-icons">arrow_forward_ios</i>
                    </div>
                </a>
                <a href="/expenses/incomes" class="modern-menu-card">
                    <div class="card-icon incomes-icon">
                        <i class="material-icons">attach_money</i>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">収入データ登録</h3>
                        <p class="card-description">給与、投資収入、年金などを登録</p>
                    </div>
                    <div class="card-arrow">
                        <i class="material-icons">arrow_forward_ios</i>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let plansData = [];

document.addEventListener('DOMContentLoaded', function() {
    // データを先に読み込む
    loadPlanList();
    checkDataAvailability();
    
    // 選択UIを初期化
    initializeSelectionUI();
});

// 選択UIの初期化
function initializeSelectionUI() {
    window.selectionUI = new SelectionUI({
        onCopy: handleCopy,
        onDelete: handleDelete,
        onEdit: handleEdit,
        onCancel: handleCancel,
        getItemId: (element) => element.dataset.planId
    });
}

// コピー処理
async function handleCopy(selectedIds) {
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/simulation-plans/${id}/copy`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件のプランをコピーしました`, 'success');
            loadPlanList();
        } else {
            showToast('プランのコピーに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error copying plans:', error);
        showToast('プランのコピー中にエラーが発生しました', 'error');
    }
}

// 削除処理
async function handleDelete(selectedIds) {
    const confirmMessage = `選択した${selectedIds.length}件のプランを削除しますか？`;
    if (!confirm(confirmMessage)) return;
    
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/simulation-plans/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件のプランを削除しました`, 'success');
            loadPlanList();
        } else {
            showToast('プランの削除に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error deleting plans:', error);
        showToast('プランの削除中にエラーが発生しました', 'error');
    }
}

// 編集処理
async function handleEdit(planId) {
    window.location.href = `/simulation/edit/${planId}`;
}

// キャンセル処理
function handleCancel() {
    // 選択モード終了時の処理
    console.log('Selection mode cancelled');
}

// プラン一覧の読み込み
async function loadPlanList() {
    try {
        const plans = await apiCall('/api/simulation-plans');
        plansData = plans;
        renderPlanList(plans);
        
        // 選択UIの表示制御
        if (window.selectionUI) {
            if (plans.length > 0) {
                window.selectionUI.show();
            } else {
                window.selectionUI.hide();
            }
        }
    } catch (error) {
        console.error('Error loading plan list:', error);
    }
}

// プラン一覧の表示
function renderPlanList(plans) {
    const listContainer = document.getElementById('planList');
    if (plans.length === 0) {
        listContainer.innerHTML = `
            <div class="empty-state">
                <div style="text-align: center; padding: 2rem; color: var(--color-secondary);">
                    <i class="material-icons" style="font-size: 3rem;">description</i>
                    <p>登録済みのプランがありません</p>
                    <p class="text-small">右下の「+」ボタンから作成してください</p>
                </div>
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="modern-menu-grid">
            ${plans.map(plan => `
                <div class="modern-menu-card plan-card" 
                     data-selectable="true" 
                     data-plan-id="${plan.id}"
                     style="position: relative; cursor: pointer; display: flex; align-items: center; min-height: 80px;" 
                     onclick="handlePlanClick(${plan.id})">
                    <div class="card-icon" style="background-color: ${plan.color || '#e0e0e0'}30; color: ${plan.color || '#5f6368'}; margin-right: 16px;">
                        <i class="material-icons">${plan.icon || 'description'}</i>
                    </div>
                    <div class="card-content" style="flex: 1;">
                        <h3 class="card-title" style="margin-bottom: 8px; font-size: 1.1em; font-weight: 600;">${plan.name}</h3>
                        <p class="card-description" style="margin-bottom: 0; line-height: 1.4; color: var(--color-text-secondary);">
                            ${plan.start_year}年-${plan.end_year}年
                            ${plan.description ? `<br><span style="color: var(--color-text-secondary); font-size: 0.9em; font-style: italic;">${plan.description}</span>` : ''}
                        </p>
                    </div>
                    <div class="card-arrow" style="color: var(--color-text-secondary); pointer-events: none;">
                        <i class="material-icons menu-arrow" style="font-size: 20px;">chevron_right</i>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    listContainer.innerHTML = html;
}

// プランクリック処理
function handlePlanClick(planId) {
    // 選択モード中はクリックを無効化
    if (window.selectionUI && window.selectionUI.isSelectionMode) {
        return;
    }
    
    window.location.href = `/simulation/run/${planId}`;
}

// データ有無チェック
async function checkDataAvailability() {
    try {
        const [allExpenses, allIncomes] = await Promise.all([
            apiCall('/api/all-expenses'),
            apiCall('/api/all-incomes')
        ]);
        
        const hasExpenseData = Object.values(allExpenses).some(arr => arr && arr.length > 0);
        const hasIncomeData = Object.values(allIncomes).some(arr => arr && arr.length > 0);
        const hasData = hasExpenseData || hasIncomeData;
        
        if (hasData) {
            document.getElementById('noDataMessage').classList.add('hidden');
        } else {
            document.getElementById('noDataMessage').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error checking data availability:', error);
    }
}
</script>
{% endblock %} 