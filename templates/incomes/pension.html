{% extends "base-new.html" %}

{% block title %}年金収入管理{% endblock %}
{% block page_title %}年金収入管理{% endblock %}

{% block content %}
<div class="modern-tabs-container">
    <!-- プラン管理コンテンツ -->
    <div class="modern-tab-content active">
        <div class="content-section">
            <!-- 登録済み年金収入一覧 -->
            <div id="pension-income-list">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>
</div>

<!-- フローティングボタン -->
<div class="fab-container" id="fabContainer">
    <a href="/incomes/pension/new" class="fab-button add" title="新規追加">
        <i class="material-icons">add</i>
    </a>
</div>

<!-- 年金収入統計 -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">年金収入統計</h3>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-pension-count" style="color: var(--color-accent);">0</div>
                <div class="stat-label">登録年金数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-pension-monthly" style="color: var(--color-accent);">¥0</div>
                <div class="stat-label">月額合計</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-pension-annual" style="color: var(--color-accent);">¥0</div>
                <div class="stat-label">年額合計</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pensionIncomesData = [];

document.addEventListener('DOMContentLoaded', function() {
    // 年金収入データ読み込み
    loadPensionIncomes();
    
    // 選択UIを初期化
    initializeSelectionUI();
});

// 選択UIの初期化
function initializeSelectionUI() {
    window.selectionUI = new SelectionUI({
        onCopy: handleCopy,
        onDelete: handleDelete,
        onEdit: handleEdit,
        onCancel: handleCancel,
        getItemId: (element) => element.dataset.incomeId
    });
}

// コピー処理
async function handleCopy(selectedIds) {
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/pension-incomes/${id}/copy`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件の年金収入をコピーしました`, 'success');
            loadPensionIncomes();
        } else {
            showToast('年金収入のコピーに失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error copying pension incomes:', error);
        showToast('年金収入のコピー中にエラーが発生しました', 'error');
    }
}

// 削除処理
async function handleDelete(selectedIds) {
    const confirmMessage = `選択した${selectedIds.length}件の年金収入を削除しますか？`;
    if (!confirm(confirmMessage)) return;
    
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/pension-incomes/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件の年金収入を削除しました`, 'success');
            loadPensionIncomes();
        } else {
            showToast('年金収入の削除に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error deleting pension incomes:', error);
        showToast('年金収入の削除中にエラーが発生しました', 'error');
    }
}

// 編集処理
async function handleEdit(incomeId) {
    window.location.href = `/incomes/pension/edit/${incomeId}`;
}

// キャンセル処理
function handleCancel() {
    // 選択モード終了時の処理
    console.log('Selection mode cancelled');
}

// 年金収入データ読み込み
async function loadPensionIncomes() {
    try {
        const pensionIncomes = await apiCall('/api/pension-incomes');
        pensionIncomesData = pensionIncomes;
        displayPensionIncomes(pensionIncomes);
        updatePensionStats(pensionIncomes);
        
        // 選択UIの表示制御
        if (window.selectionUI) {
            if (pensionIncomes.length > 0) {
                window.selectionUI.show();
            } else {
                window.selectionUI.hide();
            }
        }
    } catch (error) {
        console.error('Error loading pension incomes:', error);
        showToast('年金収入の読み込みに失敗しました', 'error');
    }
}

// 年金収入表示
function displayPensionIncomes(pensionIncomes) {
    const listContainer = document.getElementById('pension-income-list');
    
    if (pensionIncomes.length === 0) {
        listContainer.innerHTML = `
            <div class="empty-state">
                <div style="text-align: center; padding: 2rem; color: var(--color-secondary);">
                    <i class="material-icons" style="font-size: 3rem; margin-bottom: 1rem;">elderly</i>
                    <p>登録済みの年金収入がありません</p>
                    <p class="text-small">右下の「+」ボタンから作成してください</p>
                </div>
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="modern-menu-grid">
            ${pensionIncomes.map(income => {
                const monthlyAmount = (income.monthly_amount || 0) / 10000;
                const periodText = `${income.start_year}年-${income.end_year}年`;
                
                return `
                    <div class="modern-menu-card plan-card" 
                         data-selectable="true" 
                         data-income-id="${income.id}"
                         style="position: relative; cursor: pointer; display: flex; align-items: center; min-height: 80px;" 
                         onclick="handleIncomeClick(${income.id})">
                        <div class="card-content" style="flex: 1;">
                            <h3 class="card-title" style="margin-bottom: 8px; font-size: 1.1em; font-weight: 600;">${income.name}</h3>
                            <p class="card-description" style="margin-bottom: 0; line-height: 1.4; color: var(--color-text-secondary);">
                                ${periodText}<br>
                                月額 ${monthlyAmount.toFixed(1)}万円
                                ${income.description ? `<br><span style="color: var(--color-text-secondary); font-size: 0.9em; font-style: italic;">${income.description}</span>` : ''}
                            </p>
                        </div>
                        <div class="card-arrow" style="color: var(--color-text-secondary); pointer-events: none;">
                            <i class="material-icons" style="font-size: 20px;">arrow_forward_ios</i>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    listContainer.innerHTML = html;
}

// 年金収入クリック処理
function handleIncomeClick(incomeId) {
    // 選択モード中はクリックを無効化
    if (window.selectionUI && window.selectionUI.isSelectionMode) {
        return;
    }
    
    window.location.href = `/incomes/pension/edit/${incomeId}`;
}

// 年金収入統計更新
function updatePensionStats(pensionIncomes) {
    const totalCount = pensionIncomes.length;
    const totalMonthly = pensionIncomes.reduce((sum, income) => sum + (income.monthly_amount || 0), 0);
    const totalAnnual = totalMonthly * 12;
    
    document.getElementById('total-pension-count').textContent = totalCount;
    document.getElementById('total-pension-monthly').textContent = `¥${(totalMonthly / 10000).toFixed(1)}万`;
    document.getElementById('total-pension-annual').textContent = `¥${(totalAnnual / 10000).toFixed(1)}万`;
}
</script>
{% endblock %} 