{% extends "base-refactored.html" %}

{% block title %}給与収入 - {% if income_id %}編集{% else %}新規登録{% endif %} - ライフプランアプリ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/household.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="material-icons">work</i>
            {% if income_id %}給与収入編集{% else %}給与収入新規登録{% endif %}
        </h1>
        <div class="page-actions">
            <a href="/incomes/salary" class="btn btn-secondary">
                <i class="material-icons">arrow_back</i>
                一覧に戻る
            </a>
        </div>
    </div>
</div>

<!-- 基本情報カード -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="material-icons">edit</i>
            基本情報
        </h3>
    </div>
    <div class="card-body">
        <form id="salaryIncomeForm">
            <input type="hidden" name="id" value="{{ income_id or '' }}">
            
            <div class="form-row">
                <label class="form-label">項目名 <span class="text-danger">*</span></label>
                <input type="text" name="name" class="form-control" placeholder="例：本業給与" required>
            </div>
            
            <div class="form-row">
                <label class="form-label">説明</label>
                <input type="text" name="description" class="form-control" placeholder="詳細説明（任意）">
            </div>
            
            <div class="form-row">
                <label class="form-label">開始年 <span class="text-danger">*</span></label>
                <select name="start_year" class="form-control" required>
                    <!-- JavaScript で動的に生成 -->
                </select>
            </div>
            
            <div class="form-row">
                <label class="form-label">終了年 <span class="text-danger">*</span></label>
                <select name="end_year" class="form-control" required>
                    <!-- JavaScript で動的に生成 -->
                </select>
            </div>
        </form>
    </div>
</div>

<!-- 給与情報カード -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="material-icons">monetization_on</i>
            給与情報
        </h3>
    </div>
    <div class="card-body">
        <div class="form-row">
            <label class="form-label">月額給与（万円） <span class="text-danger">*</span></label>
            <div>
                <input type="number" name="monthly_amount" class="form-control" placeholder="30" min="0" step="0.1" required form="salaryIncomeForm">
                <small class="form-text text-muted">税込み月額給与を入力してください</small>
            </div>
        </div>
        
        <div class="form-row">
            <label class="form-label">年間ボーナス（万円）</label>
            <div>
                <input type="number" name="annual_bonus" class="form-control" placeholder="100" min="0" step="0.1" form="salaryIncomeForm">
                <small class="form-text text-muted">年間のボーナス総額を入力してください</small>
            </div>
        </div>
        
        <div class="form-row">
            <label class="form-label">昇給率（年率%）</label>
            <div>
                <input type="number" name="salary_increase_rate" class="form-control" placeholder="3.0" min="0" max="20" step="0.1" value="3.0" form="salaryIncomeForm">
                <small class="form-text text-muted">年間の給与上昇率を設定してください</small>
            </div>
        </div>
    </div>
</div>

<!-- 上限設定カード -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="material-icons">trending_up</i>
            上限設定
        </h3>
    </div>
    <div class="card-body">
        <div class="form-group mb-4">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="has_cap" name="has_cap" onchange="toggleCapInputs()" form="salaryIncomeForm">
                <label class="form-check-label" for="has_cap">
                    給与に上限を設定する
                </label>
                <small class="form-text text-muted">給与の上限額を設定したい場合はチェックしてください</small>
            </div>
        </div>
        
        <div id="cap-settings" class="cap-settings" style="display: none;">
            <div class="form-group">
                <label class="form-label">年間収入上限（万円）</label>
                <input type="number" name="annual_income_cap" class="form-control" placeholder="1000" min="0" step="0.1" form="salaryIncomeForm">
                <small class="form-text text-muted">年間の総収入（月給×12＋ボーナス）の上限額</small>
            </div>
        </div>
    </div>
</div>

<!-- プレビューカード -->
<div class="card" id="preview-card" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="material-icons">visibility</i>
            収入プレビュー
        </h3>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-2 compact-mobile gap-4">
            <div class="summary-card">
                <div class="summary-icon income">
                    <i class="material-icons">today</i>
                </div>
                <div class="summary-content">
                    <h4>月額収入</h4>
                    <p class="summary-amount" id="preview-monthly">¥0</p>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon income">
                    <i class="material-icons">calendar_today</i>
                </div>
                <div class="summary-content">
                    <h4>年間収入</h4>
                    <p class="summary-amount" id="preview-annual">¥0</p>
                </div>
            </div>
            
        </div>
        <div class="grid grid-cols-1 compact-mobile gap-4">
            <div class="summary-card">
                <div class="summary-icon warning">
                    <i class="material-icons">trending_up</i>
                </div>
                <div class="summary-content">
                    <h4>10年後予想</h4>
                    <p class="summary-amount" id="preview-future">¥0</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 操作ボタン -->
<div class="card">
    <div class="card-body">
        <div class="flex justify-between items-center">
            <a href="/incomes/salary" class="btn btn-secondary">
                <i class="material-icons">arrow_back</i>
                キャンセル
            </a>
            <div class="flex gap-2">
                <button type="button" class="btn btn-outline" onclick="togglePreview()">
                    <i class="material-icons">visibility</i>
                    プレビュー
                </button>
                <button type="submit" class="btn btn-primary" form="salaryIncomeForm">
                    <i class="material-icons">save</i>
                    {% if income_id %}更新{% else %}登録{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeYearSelects();
    
    const incomeId = document.querySelector('[name="id"]').value;
    if (incomeId) {
        loadIncomeData(incomeId);
    }
    
    setupFormHandler();
    setupAutoPreview();
});

function initializeYearSelects() {
    const currentYear = new Date().getFullYear();
    const startYearSelect = document.querySelector('[name="start_year"]');
    const endYearSelect = document.querySelector('[name="end_year"]');
    
    for (let year = currentYear; year <= currentYear + 50; year++) {
        const startOption = new Option(year + '年', year);
        const endOption = new Option(year + '年', year);
        
        if (year === currentYear) startOption.selected = true;
        if (year === currentYear + 30) endOption.selected = true;
        
        startYearSelect.add(startOption);
        endYearSelect.add(endOption);
    }
}

function setupFormHandler() {
    const form = document.getElementById('salaryIncomeForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await handleFormSubmit(this);
    });
}

function setupAutoPreview() {
    const form = document.getElementById('salaryIncomeForm');
    const inputs = form.querySelectorAll('input[type="number"]');
    
    inputs.forEach(input => {
        input.addEventListener('input', updatePreview);
    });
}

function toggleCapInputs() {
    const hasCapCheckbox = document.getElementById('has_cap');
    const capSettings = document.getElementById('cap-settings');
    
    if (hasCapCheckbox.checked) {
        capSettings.style.display = 'block';
    } else {
        capSettings.style.display = 'none';
        document.querySelector('[name="annual_income_cap"]').value = '';
    }
    updatePreview();
}

function togglePreview() {
    const previewCard = document.getElementById('preview-card');
    const isVisible = previewCard.style.display !== 'none';
    
    previewCard.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
        updatePreview();
    }
}

function updatePreview() {
    const monthlyAmount = parseFloat(document.querySelector('[name="monthly_amount"]').value) || 0;
    const annualBonus = parseFloat(document.querySelector('[name="annual_bonus"]').value) || 0;
    const increaseRate = parseFloat(document.querySelector('[name="salary_increase_rate"]').value) || 3.0;
    
    const monthlyAmountYen = monthlyAmount * 10000;
    const annualBonusYen = annualBonus * 10000;
    const annualAmount = monthlyAmountYen * 12 + annualBonusYen;
    
    // 10年後の予想収入
    const futureAmount = annualAmount * Math.pow(1 + increaseRate / 100, 10);
    
    document.getElementById('preview-monthly').textContent = '¥' + monthlyAmountYen.toLocaleString();
    document.getElementById('preview-annual').textContent = '¥' + annualAmount.toLocaleString();
    document.getElementById('preview-future').textContent = '¥' + Math.round(futureAmount).toLocaleString();
}

async function handleFormSubmit(form) {
    if (!validateForm(form)) return;
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // 数値変換（万円を円に変換）
    data.monthly_amount = (parseFloat(data.monthly_amount) || 0) * 10000;
    data.annual_bonus = (parseFloat(data.annual_bonus) || 0) * 10000;
    data.annual_amount = data.monthly_amount * 12 + data.annual_bonus;
    
    // 上限設定
    data.has_cap = document.getElementById('has_cap').checked;
    if (data.has_cap) {
        data.annual_income_cap = (parseFloat(data.annual_income_cap) || 0) * 10000;
    } else {
        data.annual_income_cap = 0;
    }
    
    data.start_year = parseInt(data.start_year) || 2024;
    data.end_year = parseInt(data.end_year) || 2050;
    data.salary_increase_rate = parseFloat(data.salary_increase_rate) || 3.0;
    
    const isUpdate = data.id && data.id !== '';
    const method = isUpdate ? 'PUT' : 'POST';
    
    try {
        const response = await fetch('/api/incomes/salary', {
            method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showNotification(isUpdate ? '給与収入を更新しました' : '給与収入を登録しました', 'success');
            setTimeout(() => {
                window.location.href = '/incomes/salary';
            }, 1500);
        } else {
            throw new Error('保存に失敗しました');
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

function validateForm(form) {
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('error');
            isValid = false;
        } else {
            field.classList.remove('error');
        }
    });
    
    if (!isValid) {
        showNotification('必須項目を入力してください', 'error');
    }
    
    return isValid;
}

function showNotification(message, type) {
    // 通知表示の実装
    console.log(`${type}: ${message}`);
}

// 初期プレビュー更新
setTimeout(updatePreview, 100);
</script>
{% endblock %} 