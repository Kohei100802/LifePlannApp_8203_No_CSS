{% extends "base-new.html" %}

{% block title %}口座管理{% endblock %}
{% block page_title %}口座管理{% endblock %}

{% block content %}
<div class="account-management-container">
    <!-- 月選択バー -->
    <div class="month-selector-bar">
        <div class="month-nav">
            <button class="month-nav-btn" onclick="goToPreviousMonth()" title="前月">
                <i class="material-icons">chevron_left</i>
            </button>
            <div class="month-title">
                <h2 id="currentMonthTitle">2025年6月</h2>
            </div>
            <button class="month-nav-btn" onclick="goToNextMonth()" title="次月">
                <i class="material-icons">chevron_right</i>
            </button>
        </div>
        
        <!-- 月別収支サマリー -->
        <div class="month-summary">
            <div class="summary-item income">
                <div class="summary-label">収入</div>
                <div class="summary-amount" id="monthlyIncome">¥0</div>
            </div>
            <div class="summary-item expense">
                <div class="summary-label">支出</div>
                <div class="summary-amount" id="monthlyExpense">¥0</div>
            </div>
            <div class="summary-item balance" id="monthlyBalanceCard">
                <div class="summary-label">収支</div>
                <div class="summary-amount" id="monthlyBalance">¥0</div>
            </div>
        </div>
    </div>

    <!-- 収入源セクション -->
    <div class="income-sources-section">
        <div class="section-header">
            <h3><i class="material-icons">trending_up</i> 収入源</h3>
        </div>
        
        <div class="income-sources-grid">
            <div class="income-sources-content">
                <div class="income-source" data-income-type="salary">
                    <div class="income-icon">
                        <i class="material-icons">work</i>
                    </div>
                    <div class="income-info">
                        <div class="income-name">給与所得</div>
                        <div class="income-description">会社からの給与・賞与</div>
                    </div>
                </div>
                
                <div class="income-source" data-income-type="sidejob">
                    <div class="income-icon">
                        <i class="material-icons">laptop</i>
                    </div>
                    <div class="income-info">
                        <div class="income-name">副業収入</div>
                        <div class="income-description">フリーランス・副業</div>
                    </div>
                </div>
                
                <div class="income-source" data-income-type="investment">
                    <div class="income-icon">
                        <i class="material-icons">show_chart</i>
                    </div>
                    <div class="income-info">
                        <div class="income-name">投資収益</div>
                        <div class="income-description">株式・投資信託</div>
                    </div>
                </div>
                
                <div class="income-source" data-income-type="rental">
                    <div class="income-icon">
                        <i class="material-icons">home</i>
                    </div>
                    <div class="income-info">
                        <div class="income-name">不動産収入</div>
                        <div class="income-description">賃貸・家賃収入</div>
                    </div>
                </div>
                
                <div class="income-source" data-income-type="pension">
                    <div class="income-icon">
                        <i class="material-icons">elderly</i>
                    </div>
                    <div class="income-info">
                        <div class="income-name">年金</div>
                        <div class="income-description">国民・厚生年金</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 口座一覧セクション -->
    <div class="accounts-section">
        <div class="section-header">
            <h3><i class="material-icons">account_balance</i> 口座一覧</h3>
        </div>
        
        <div class="accounts-grid" id="accounts-grid">
            <div class="accounts-content" id="accounts-content">
                <!-- 口座カードは JavaScript で動的に生成 -->
            </div>
        </div>
    </div>

    <!-- 支出項目セクション -->
    <div class="expense-categories-section">
        <div class="section-header">
            <h3><i class="material-icons">receipt_long</i> 支出項目</h3>
        </div>
        <div class="expense-categories-grid">
            <div class="expense-categories-content">
                {% for category in expense_categories %}
                    <div class="expense-category-card">
                        <div class="expense-category-icon" style="background-color: {{ category.color }}30; color: {{ category.color }};">
                            <i class="material-icons">{{ category.icon }}</i>
                        </div>
                        <div class="expense-category-name">{{ category.name }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 長押しドラッグ用の遠景要素 -->
<div id="drag-preview" class="drag-preview">
    <div class="drag-preview-content">
        <div class="drag-preview-icon"></div>
        <div class="drag-preview-amount"></div>
    </div>
</div>

<!-- フローティングボタン -->
<div class="fab-container" id="fabContainer">
    <button class="fab-button add" title="新規口座作成" onclick="showCreateAccountModal()">
        <i class="material-icons">add</i>
    </button>
</div>

<!-- 口座作成モーダル -->
<div id="create-account-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="create-modal-title">新しい口座を作成</h3>
            <button class="modal-close" onclick="hideCreateAccountModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">口座名</label>
                <input type="text" id="account-name" class="form-control" placeholder="例：メイン口座">
            </div>
            <div class="form-group">
                <label class="form-label">口座種別</label>
                <select id="account-type" class="form-control">
                    <option value="普通預金">普通預金</option>
                    <option value="定期預金">定期預金</option>
                    <option value="現金">現金</option>
                    <option value="クレジット">クレジットカード</option>
                    <option value="投資">投資口座</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">説明文（任意）</label>
                <input type="text" id="account-description" class="form-control" placeholder="例：給与受取用口座、投資用資金">
            </div>
            <div class="form-group">
                <label class="form-label">初期残高</label>
                <input type="number" id="account-balance" class="form-control" placeholder="0" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">アイコン</label>
                <div class="icon-selector">
                    <div class="icon-option selected" data-icon="account_balance">
                        <i class="material-icons">account_balance</i>
                    </div>
                    <div class="icon-option" data-icon="account_balance_wallet">
                        <i class="material-icons">account_balance_wallet</i>
                    </div>
                    <div class="icon-option" data-icon="credit_card">
                        <i class="material-icons">credit_card</i>
                    </div>
                    <div class="icon-option" data-icon="savings">
                        <i class="material-icons">savings</i>
                    </div>
                    <div class="icon-option" data-icon="trending_up">
                        <i class="material-icons">trending_up</i>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">カラー</label>
                <div class="color-selector">
                    <div class="color-option selected" data-color="#2196F3"></div>
                    <div class="color-option" data-color="#4CAF50"></div>
                    <div class="color-option" data-color="#FF9800"></div>
                    <div class="color-option" data-color="#9C27B0"></div>
                    <div class="color-option" data-color="#F44336"></div>
                    <div class="color-option" data-color="#607D8B"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideCreateAccountModal()">キャンセル</button>
            <button type="button" class="btn btn-primary" id="create-account-btn" onclick="createAccount()">作成</button>
        </div>
    </div>
</div>

<!-- 家計簿登録モーダル -->
<div id="householdEntryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <i class="material-icons">receipt_long</i>
                家計簿に登録
            </h3>
            <button class="modal-close" onclick="closeHouseholdEntryModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        <form id="householdEntryForm" class="entry-form">
            <input type="hidden" id="sourceAccountId" name="source_account_id">
            <input type="hidden" id="expenseCategoryId" name="expense_category_id">
            <input type="hidden" id="entryYear" name="entry_year">
            <input type="hidden" id="entryMonth" name="entry_month">
            
            <!-- ドラッグ元とドロップ先の表示 -->
            <div class="transfer-info">
                <div class="transfer-from">
                    <div class="transfer-label">支払い元</div>
                    <div class="transfer-account" id="sourceAccountDisplay">
                        <i class="material-icons">account_balance_wallet</i>
                        <span id="sourceAccountName">財布</span>
                    </div>
                </div>
                <div class="transfer-arrow">
                    <i class="material-icons">arrow_forward</i>
                </div>
                <div class="transfer-to">
                    <div class="transfer-label">支出項目</div>
                    <div class="transfer-category" id="targetCategoryDisplay">
                        <i class="material-icons">category</i>
                        <span id="targetCategoryName">食費</span>
                    </div>
                </div>
            </div>
            
            <!-- 金額入力 -->
            <div class="amount-input">
                <label for="householdAmount">支出金額</label>
                <div class="amount-field">
                    <span class="currency">¥</span>
                    <input type="number" id="householdAmount" name="amount" placeholder="0" required min="1" step="1">
                </div>
            </div>
            
            <!-- 日付選択 -->
            <div class="form-group">
                <label for="householdDate">日付</label>
                <input type="date" id="householdDate" name="entry_date" required>
            </div>
            
            <!-- 説明入力 -->
            <div class="form-group">
                <label for="householdDescription">説明（任意）</label>
                <input type="text" id="householdDescription" name="description" placeholder="例：スーパーでの買い物">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeHouseholdEntryModal()">キャンセル</button>
                <button type="submit" class="btn-primary">登録</button>
            </div>
        </form>
    </div>
</div>

<!-- 資産移動確認モーダル -->
<div id="transfer-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>資産移動の確認</h3>
            <button class="modal-close" onclick="hideTransferModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="transfer-info">
                <div class="transfer-from">
                    <div class="transfer-label">移動元</div>
                    <div class="transfer-account" id="transfer-from-account">
                        <!-- 動的に設定 -->
                    </div>
                </div>
                <div class="transfer-arrow">
                    <i class="material-icons">arrow_forward</i>
                </div>
                <div class="transfer-to">
                    <div class="transfer-label">移動先</div>
                    <div class="transfer-account" id="transfer-to-account">
                        <!-- 動的に設定 -->
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">移動金額</label>
                <input type="number" id="transfer-amount" class="form-control" placeholder="金額を入力" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">メモ（任意）</label>
                <input type="text" id="transfer-memo" class="form-control" placeholder="移動理由など">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideTransferModal()">キャンセル</button>
            <button type="button" class="btn btn-primary" onclick="executeTransfer()">移動実行</button>
        </div>
    </div>
</div>

<!-- 口座編集モーダル -->
<div id="edit-account-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>口座情報を編集</h3>
            <button class="modal-close" onclick="hideEditAccountModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">口座名</label>
                <input type="text" id="edit-account-name" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">アイコン</label>
                <div id="edit-icon-selector" class="icon-selector"></div>
            </div>
            <div class="form-group">
                <label class="form-label">カラー</label>
                <div id="edit-color-selector" class="color-selector"></div>
            </div>
            <div class="form-group">
                <label class="form-label">説明文（任意）</label>
                <input type="text" id="edit-account-description" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideEditAccountModal()">キャンセル</button>
            <button type="button" class="btn btn-primary" id="edit-account-btn">変更</button>
        </div>
    </div>
</div>

<script>
let accounts = [];
let expenseCategories = [];
let currentTransfer = {};
let editingAccountId = null;

// 月選択関連の変数
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// 長押しドラッグ関連の変数
let longPressTimer = null;
let isDragging = false;
let dragStartPos = { x: 0, y: 0 };
let currentDragElement = null;
let dragPreview = null;

// ページ読み込み時
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
    loadExpenseCategories();
    setupLongPressDrag();
    initializeMonth();
    loadMonthlySummary();
    
    // 選択UIを初期化
    initializeSelectionUI();
});

// 月の初期化
function initializeMonth() {
    updateMonthTitle();
    // 今日の日付を家計簿登録フォームにセット
    const today = new Date();
    const dateStr = today.getFullYear() + '-' + 
                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(today.getDate()).padStart(2, '0');
    const householdDateInput = document.getElementById('householdDate');
    if (householdDateInput) {
        householdDateInput.value = dateStr;
    }
}

// 月タイトルの更新
function updateMonthTitle() {
    const monthTitle = document.getElementById('currentMonthTitle');
    if (monthTitle) {
        monthTitle.textContent = `${currentYear}年${currentMonth}月`;
    }
}

// 前月へ移動
function goToPreviousMonth() {
    currentMonth--;
    if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    updateMonthTitle();
    loadMonthlySummary();
}

// 次月へ移動
function goToNextMonth() {
    currentMonth++;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    }
    updateMonthTitle();
    loadMonthlySummary();
}

// 月別収支サマリーの読み込み
function loadMonthlySummary() {
    fetch(`/api/monthly-summary/${currentYear}/${currentMonth}`)
        .then(response => response.json())
        .then(data => {
            const monthlyIncome = document.getElementById('monthlyIncome');
            const monthlyExpense = document.getElementById('monthlyExpense');
            const monthlyBalance = document.getElementById('monthlyBalance');
            const monthlyBalanceCard = document.getElementById('monthlyBalanceCard');
            
            // APIから返されるキーに合わせて修正
            const income = data.total_income || 0;
            const expense = data.total_expense || 0;
            const balance = data.balance || 0;
            
            if (monthlyIncome) monthlyIncome.textContent = `¥${income.toLocaleString()}`;
            if (monthlyExpense) monthlyExpense.textContent = `¥${expense.toLocaleString()}`;
            if (monthlyBalance) monthlyBalance.textContent = `¥${balance.toLocaleString()}`;
            
            // 収支の色を設定
            if (monthlyBalanceCard) {
                monthlyBalanceCard.className = 'summary-item balance ' + (balance >= 0 ? 'positive' : 'negative');
            }
        })
        .catch(error => {
            console.error('月別サマリーの読み込みエラー:', error);
        });
}

// 支出カテゴリの読み込み
function loadExpenseCategories() {
    fetch('/api/expense-categories')
        .then(response => response.json())
        .then(data => {
            console.log('Loaded expense categories:', data);
            // データが配列でない場合は配列に変換
            if (Array.isArray(data)) {
                expenseCategories = data;
            } else if (data.success && data.categories && Array.isArray(data.categories)) {
                expenseCategories = data.categories;
            } else if (data.categories && Array.isArray(data.categories)) {
                expenseCategories = data.categories;
            } else if (data.success && Array.isArray(data.data)) {
                expenseCategories = data.data;
            } else {
                expenseCategories = [];
                console.error('Expense categories is not an array:', data);
            }
            console.log('Final expense categories:', expenseCategories);
        })
        .catch(error => {
            console.error('支出カテゴリの読み込みエラー:', error);
            expenseCategories = [];
        });
}

// 家計簿登録フォームの設定
function setupHouseholdEntryForm() {
    const form = document.getElementById('householdEntryForm');
    if (form) {
        form.addEventListener('submit', handleHouseholdEntrySubmit);
    }
}

// 家計簿登録フォームの送信処理
function handleHouseholdEntrySubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        source_account_id: parseInt(formData.get('source_account_id')),
        expense_category_id: parseInt(formData.get('expense_category_id')),
        amount: parseInt(formData.get('amount')),
        entry_date: formData.get('entry_date'),
        description: formData.get('description') || '',
        entry_year: parseInt(formData.get('entry_year')),
        entry_month: parseInt(formData.get('entry_month'))
    };
    
    // バリデーション
    if (!data.amount || data.amount <= 0) {
        showToast('金額を正しく入力してください', 'error');
        return;
    }
    
    if (!data.entry_date) {
        showToast('日付を選択してください', 'error');
        return;
    }
    
    fetch('/api/household-entries-from-account', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeHouseholdEntryModal();
            loadMonthlySummary();
            loadAccounts(); // 口座残高を更新
            showToast('家計簿に登録しました', 'success');
        } else {
            showToast('エラー: ' + (result.error || '登録に失敗しました'), 'error');
        }
    })
    .catch(error => {
        console.error('家計簿登録エラー:', error);
        showToast('登録に失敗しました', 'error');
    });
}

// 家計簿登録モーダルを閉じる
function closeHouseholdEntryModal() {
    const modal = document.getElementById('householdEntryModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 長押しドラッグの設定
function setupLongPressDrag() {
    const container = document.querySelector('.account-management-container');
    dragPreview = document.getElementById('drag-preview');
    
    if (!container || !dragPreview) {
        console.error('Required elements not found');
        return;
    }
    
    // タッチイベントの設定（横スクロール優先でpassive: trueに変更）
    container.addEventListener('touchstart', handleTouchStart, { passive: true });
    container.addEventListener('touchmove', handleTouchMove, { passive: true });
    container.addEventListener('touchend', handleTouchEnd, { passive: true });
    
    // マウスイベントの設定（デスクトップ対応）
    container.addEventListener('mousedown', handleMouseDown, { passive: false });
    container.addEventListener('mousemove', handleMouseMove, { passive: false });
    container.addEventListener('mouseup', handleMouseUp, { passive: false });
    
    // グローバルイベント（ドラッグ中に画面外に出た場合の対応）
    document.addEventListener('touchmove', function(e) {
        if (isDragging && e.cancelable) {
            e.preventDefault();
        }
    }, { passive: false });
    
    document.addEventListener('mousemove', function(e) {
        if (isDragging) {
            e.preventDefault();
        }
    }, { passive: false });
}

// タッチ開始
function handleTouchStart(e) {
    const target = e.target.closest('.account-card, .income-source');
    if (!target) return;
    
    // passive: trueなのでe.preventDefault()は削除
    const touch = e.touches[0];
    startLongPress(target, touch.clientX, touch.clientY);
}

// マウス押下
function handleMouseDown(e) {
    const target = e.target.closest('.account-card, .income-source');
    if (!target) return;
    
    e.preventDefault();
    startLongPress(target, e.clientX, e.clientY);
}

// 長押し開始
function startLongPress(element, x, y) {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
    }
    
    currentDragElement = element;
    dragStartPos = { x, y };
    
    // 長押しタイマー開始（500ms）
    longPressTimer = setTimeout(() => {
        // 0.5秒以内に20px以上の横移動がない場合のみドラッグ開始
        startDrag(element, x, y);
    }, 500);
    
    // 長押し中の視覚フィードバック
    element.classList.add('long-press-active');
}

// 強力な振動フィードバック関数（Twitterライク）
function triggerStrongVibration() {
    console.log('=== VIBRATION TEST START ===');
    console.log('User Agent:', navigator.userAgent);
    console.log('Vibrate support:', !!navigator.vibrate);
    
    // Android/Chrome用の強力な振動パターン
    if (navigator.vibrate) {
        // Twitterライクの強力な振動パターン：長い-短い-長い-短い-長い
        const result = navigator.vibrate([200, 100, 300, 100, 200]);
        console.log('Strong vibration pattern triggered, result:', result);
        
        // 追加の振動パターンで確実に感じられるように
        setTimeout(() => {
            if (navigator.vibrate) {
                const result2 = navigator.vibrate([150]);
                console.log('Additional vibration triggered, result:', result2);
            }
        }, 800);
    } else {
        console.log('navigator.vibrate not supported');
    }
    
    // iOS Safari用のHaptic Feedback（iOS 13+）
    if (window.DeviceMotionEvent && navigator.userAgent.match(/iPhone|iPad|iPod/)) {
        console.log('iOS device detected, trying audio feedback');
        try {
            // Web Audio APIを使用した強力な音響フィードバック
            if (window.AudioContext || window.webkitAudioContext) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('AudioContext created');
                
                // より強力で長い音響フィードバック
                const frequencies = [300, 500, 700, 900];
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = freq;
                        gainNode.gain.value = 0.08; // 音量を上げる
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.12); // より長く
                        console.log('Audio feedback triggered at frequency:', freq);
                    }, index * 80);
                });
            }
        } catch (e) {
            console.log('iOS Haptic feedback not available:', e);
        }
    }
    
    // 代替案：古いデバイス用の連続振動
    if (!navigator.vibrate && window.navigator && window.navigator.vibrate) {
        console.log('Trying alternative vibration method');
        window.navigator.vibrate([200, 100, 300, 100, 200]);
    }
    
    // 追加の振動チェック（最大互換性のため）
    try {
        // 異なるAPIでも試行
        if (window.navigator && typeof window.navigator.vibrate === 'function') {
            console.log('Trying window.navigator.vibrate');
            window.navigator.vibrate([250, 100, 350, 100, 250]);
        }
        
        // Cordova/PhoneGap環境
        if (window.navigator && window.navigator.notification && window.navigator.notification.vibrate) {
            console.log('Trying Cordova vibration');
            window.navigator.notification.vibrate(500);
        }
        
        // 古いAndroid環境
        if (window.navigator && window.navigator.vibrate && typeof window.navigator.vibrate === 'function') {
            console.log('Trying old Android vibration');
            window.navigator.vibrate(300);
        }
    } catch (e) {
        console.log('Alternative vibration methods failed:', e);
    }
    
    console.log('=== VIBRATION TEST END ===');
}

// ドラッグ開始
function startDrag(element, x, y) {
    console.log('Starting drag for element:', element);
    
    currentDragElement = element;
    isDragging = true;
    element.classList.remove('long-press-active');
    element.classList.add('dragging');
    
    // 遠景プレビューを作成
    createDragPreview(element, x, y);
    
    // 強力な振動フィードバック（Twitterライク）
    triggerStrongVibration();
}

// 遠景プレビュー作成
function createDragPreview(element, x, y) {
    console.log('Creating drag preview at:', x, y);
    
    // プレビューの内容を設定
    const icon = element.querySelector('.account-icon i, .income-icon i');
    const name = element.querySelector('.account-info h4, .income-name');
    const balance = element.querySelector('.account-balance');
    
    const previewIcon = dragPreview.querySelector('.drag-preview-icon');
    const previewAmount = dragPreview.querySelector('.drag-preview-amount');
    
    if (icon && previewIcon) {
        previewIcon.innerHTML = `<i class="material-icons">${icon.textContent}</i>`;
    }
    
    if (balance && previewAmount) {
        previewAmount.textContent = balance.textContent;
    } else if (name && previewAmount) {
        previewAmount.textContent = name.textContent;
    }
    
    // プレビューの位置を設定（30pxサイズ、中心からオフセット）
    dragPreview.style.left = (x - 15) + 'px';
    dragPreview.style.top = (y - 15) + 'px';
    dragPreview.style.display = 'block';
    dragPreview.classList.add('active');
    
    console.log('Drag preview created and positioned');
}

// タッチ移動
function handleTouchMove(e) {
    if (longPressTimer && !isDragging) {
        // 長押し中に移動した場合の判定を変更（20px以上の横移動でキャンセル）
        const touch = e.touches[0];
        const horizontalDistance = Math.abs(touch.clientX - dragStartPos.x);
        const verticalDistance = Math.abs(touch.clientY - dragStartPos.y);
        
        // 20px以上の横移動があった場合は横スクロール優先でドラッグをキャンセル
        if (horizontalDistance > 20) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            if (currentDragElement) {
                currentDragElement.classList.remove('long-press-active');
                currentDragElement = null;
            }
            return;
        }
        
        // 縦移動が大きい場合も一応キャンセル（縦スクロール優先）
        if (verticalDistance > 30) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            if (currentDragElement) {
                currentDragElement.classList.remove('long-press-active');
                currentDragElement = null;
            }
            return;
        }
    }
    
    if (!isDragging) return;
    
    // passive: trueのため、preventDefaultは呼び出さない
    // グローバルイベントリスナーでpreventDefaultを処理
    const touch = e.touches[0];
    updateDragPreview(touch.clientX, touch.clientY);
    checkDropTarget(touch.clientX, touch.clientY);
}

// マウス移動
function handleMouseMove(e) {
    if (longPressTimer && !isDragging) {
        // 長押し中に移動した場合、長押しをキャンセル
        const moveDistance = Math.sqrt(
            Math.pow(e.clientX - dragStartPos.x, 2) + 
            Math.pow(e.clientY - dragStartPos.y, 2)
        );
        
        if (moveDistance > 10) { // 10px以上移動したらキャンセル
            clearTimeout(longPressTimer);
            longPressTimer = null;
            if (currentDragElement) {
                currentDragElement.classList.remove('long-press-active');
            }
        }
        return;
    }
    
    if (!isDragging) return;
    
    e.preventDefault();
    updateDragPreview(e.clientX, e.clientY);
    checkDropTarget(e.clientX, e.clientY);
}

// プレビュー位置更新
function updateDragPreview(x, y) {
    if (dragPreview) {
        dragPreview.style.left = (x - 15) + 'px';
        dragPreview.style.top = (y - 15) + 'px';
    }
}

// ドロップターゲット確認
function checkDropTarget(x, y) {
    // 現在の要素を一時的に非表示にして、下の要素を取得
    dragPreview.style.display = 'none';
    const elementBelow = document.elementFromPoint(x, y);
    dragPreview.style.display = 'block';
    
    // すべてのドロップターゲットをリセット
    document.querySelectorAll('.drop-target').forEach(el => {
        el.classList.remove('drop-target');
    });
    
    // 新しいドロップターゲットを設定
    const accountDropTarget = elementBelow?.closest('.account-card');
    const expenseDropTarget = elementBelow?.closest('.expense-category-card');
    
    if (accountDropTarget && accountDropTarget !== currentDragElement) {
        accountDropTarget.classList.add('drop-target');
    } else if (expenseDropTarget && currentDragElement?.classList.contains('account-card')) {
        // 口座から支出項目へのドロップのみ許可
        expenseDropTarget.classList.add('drop-target');
    }
}

// タッチ終了
function handleTouchEnd(e) {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    
    if (isDragging) {
        const touch = e.changedTouches[0];
        endDrag(touch.clientX, touch.clientY);
    } else {
        // 通常のタップ処理
        if (currentDragElement) {
            currentDragElement.classList.remove('long-press-active');
        }
    }
    
    resetDragState();
}

// マウス終了
function handleMouseUp(e) {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    
    if (isDragging) {
        endDrag(e.clientX, e.clientY);
    } else {
        if (currentDragElement) {
            currentDragElement.classList.remove('long-press-active');
        }
    }
    
    resetDragState();
}

// ドラッグ終了
function endDrag(x, y) {
    console.log('Ending drag at:', x, y);
    
    // ドロップターゲットを確認
    dragPreview.style.display = 'none';
    const elementBelow = document.elementFromPoint(x, y);
    const accountDropTarget = elementBelow?.closest('.account-card');
    const expenseDropTarget = elementBelow?.closest('.expense-category-card');
    
    if (accountDropTarget && accountDropTarget !== currentDragElement) {
        // 資産移動処理
        console.log('Account drop target found:', accountDropTarget);
        initiateTransfer(currentDragElement, accountDropTarget);
    } else if (expenseDropTarget && currentDragElement?.classList.contains('account-card')) {
        // 家計簿登録処理
        console.log('Expense drop target found:', expenseDropTarget);
        initiateHouseholdEntry(currentDragElement, expenseDropTarget);
    }
    
    // 視覚効果をリセット
    dragPreview.style.display = 'block';
    setTimeout(() => {
        dragPreview.classList.remove('active');
        setTimeout(() => {
            dragPreview.style.display = 'none';
        }, 200);
    }, 100);
}

// ドラッグ状態リセット
function resetDragState() {
    if (currentDragElement) {
        currentDragElement.classList.remove('long-press-active', 'dragging');
    }
    
    document.querySelectorAll('.drop-target').forEach(el => {
        el.classList.remove('drop-target');
    });
    
    isDragging = false;
    currentDragElement = null;
    dragStartPos = { x: 0, y: 0 };
}

// 資産移動開始
function initiateTransfer(fromElement, toElement) {
    const fromData = getElementData(fromElement);
    const toData = getElementData(toElement);
    
    if (!fromData || !toData) return;
    
    currentTransfer = {
        from: fromData,
        to: toData
    };
    
    showTransferModal(fromData, toData);
}

// 要素データ取得
function getElementData(element) {
    if (element.classList.contains('account-card')) {
        const accountId = element.dataset.accountId;
        return accounts.find(acc => acc.id == accountId);
    } else if (element.classList.contains('income-source')) {
        return {
            type: 'income',
            income_type: element.dataset.incomeType,
            name: element.querySelector('.income-name').textContent,
            icon: element.querySelector('.income-icon i').textContent
        };
    }
    return null;
}

// 口座データの読み込み
function loadAccounts() {
    fetch('/api/accounts')
        .then(response => response.json())
        .then(data => {
            // data.accounts が配列ならそれを使う
            accounts = Array.isArray(data) ? data : data.accounts || [];
            renderAccounts(accounts);
            
            // 選択UIの表示制御
            if (window.selectionUI) {
                if (accounts.length > 0) {
                    window.selectionUI.show();
                } else {
                    window.selectionUI.hide();
                }
            }
        })
        .catch(error => {
            console.error('口座データの読み込みエラー:', error);
            // エラー時も選択UIを非表示
            if (window.selectionUI) {
                window.selectionUI.hide();
            }
        });
}

function renderAccounts(accounts) {
    const content = document.getElementById('accounts-content');
    content.innerHTML = '';
    
    accounts.forEach(account => {
        const accountCard = createAccountCard(account);
        content.appendChild(accountCard);
    });
}

function createAccountCard(account) {
    const card = document.createElement('div');
    card.className = 'account-card';
    card.dataset.accountId = account.id;
    card.dataset.selectable = 'true';
    
    card.innerHTML = `
        <div class="account-header">
            <div class="account-icon" style="background-color: ${account.color}">
                <i class="material-icons">${account.icon}</i>
            </div>
            <div class="account-info">
                <h4>${account.name}</h4>
                <div class="account-type">${account.account_type}</div>
            </div>
        </div>
        <div class="account-balance">¥${account.balance.toLocaleString()}</div>
    `;
    
    return card;
}

// モーダル関連の既存関数
function showCreateAccountModal() {
    document.getElementById('create-account-modal').style.display = 'block';
    // カラー選択肢のクリックイベントを毎回セット
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.onclick = function() {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
}

function hideCreateAccountModal() {
    document.getElementById('create-account-modal').style.display = 'none';
    resetCreateAccountForm();
}

function showTransferModal(fromData, toData) {
    // 移動元と移動先の情報を表示
    const fromAccount = document.getElementById('transfer-from-account');
    const toAccount = document.getElementById('transfer-to-account');
    
    if (fromData.type === 'income') {
        fromAccount.innerHTML = `
            <div class="account-icon" style="background-color: #4CAF50">
                <i class="material-icons">${fromData.icon}</i>
            </div>
            <div class="account-info">
                <div class="account-name">${fromData.name}</div>
                <div class="account-balance">収入源</div>
            </div>
        `;
    } else {
        fromAccount.innerHTML = `
            <div class="account-icon" style="background-color: ${fromData.color}">
                <i class="material-icons">${fromData.icon}</i>
            </div>
            <div class="account-info">
                <div class="account-name">${fromData.name}</div>
                <div class="account-balance">¥${fromData.balance.toLocaleString()}</div>
            </div>
        `;
    }
    
    toAccount.innerHTML = `
        <div class="account-icon" style="background-color: ${toData.color}">
            <i class="material-icons">${toData.icon}</i>
        </div>
        <div class="account-info">
            <div class="account-name">${toData.name}</div>
            <div class="account-balance">¥${toData.balance.toLocaleString()}</div>
        </div>
    `;
    
    document.getElementById('transfer-modal').style.display = 'block';
}

function hideTransferModal() {
    document.getElementById('transfer-modal').style.display = 'none';
    document.getElementById('transfer-amount').value = '';
    document.getElementById('transfer-memo').value = '';
}

// その他の既存関数（簡略化）
function createAccount() {
    const name = document.getElementById('account-name').value;
    const type = document.getElementById('account-type').value;
    const balance = parseFloat(document.getElementById('account-balance').value) || 0;
    const icon = document.querySelector('.icon-option.selected').dataset.icon;
    const color = document.querySelector('.color-option.selected').dataset.color;
    
    if (!name.trim()) {
        showToast('口座名を入力してください', 'error');
        return;
    }
    
    const accountData = {
        name: name,
        account_type: type,
        balance: balance,
        icon: icon,
        color: color
    };
    
    fetch('/api/accounts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(accountData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('口座が作成されました', 'success');
            hideCreateAccountModal();
            loadAccounts();
        } else {
            showToast('口座の作成に失敗しました', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('口座の作成に失敗しました', 'error');
    });
}

function executeTransfer() {
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const memo = document.getElementById('transfer-memo').value;
    
    if (!amount || amount <= 0) {
        showToast('正しい金額を入力してください', 'error');
        return;
    }
    
    const transferData = {
        from_account_id: currentTransfer.from.type === 'income' ? null : currentTransfer.from.id,
        to_account_id: currentTransfer.to.id,
        amount: amount,
        description: memo || `${currentTransfer.from.name}から${currentTransfer.to.name}への移動`,
        income_type: currentTransfer.from.type === 'income' ? currentTransfer.from.income_type : null
    };
    
    fetch('/api/account-transfer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(transferData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('資産移動が完了しました', 'success');
            hideTransferModal();
            loadAccounts();
        } else {
            showToast('資産移動に失敗しました', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('資産移動に失敗しました', 'error');
    });
}

// ユーティリティ関数
function resetCreateAccountForm() {
    document.getElementById('account-name').value = '';
    document.getElementById('account-type').value = '普通預金';
    document.getElementById('account-balance').value = '';
    document.querySelector('.icon-option.selected').classList.remove('selected');
    document.querySelector('.icon-option[data-icon="account_balance"]').classList.add('selected');
    document.querySelector('.color-option.selected').classList.remove('selected');
    document.querySelector('.color-option[data-color="#2196F3"]').classList.add('selected');
}

// アイコン・カラー選択
document.addEventListener('click', function(e) {
    if (e.target.closest('.icon-option')) {
        document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
        e.target.closest('.icon-option').classList.add('selected');
    }
    
    if (e.target.closest('.color-option')) {
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        e.target.closest('.color-option').classList.add('selected');
    }
});

function showToast(message, type = 'info') {
    // トースト通知の実装（既存のcommon.jsの関数を使用）
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}

function editAccount(accountId) {
    // 編集機能の実装（必要に応じて）
    console.log('Edit account:', accountId);
}

function deleteAccount(accountId) {
    if (confirm('この口座を削除しますか？')) {
        fetch(`/api/accounts/${accountId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('口座が削除されました', 'success');
                loadAccounts();
            } else {
                showToast('口座の削除に失敗しました', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('口座の削除に失敗しました', 'error');
        });
    }
}

// 家計簿登録開始
function initiateHouseholdEntry(accountElement, expenseElement) {
    const accountData = getElementData(accountElement);
    const expenseCategoryData = getExpenseCategoryData(expenseElement);
    
    if (!accountData || !expenseCategoryData) {
        console.error('Account or expense category data not found');
        return;
    }
    
    showHouseholdEntryModal(accountData, expenseCategoryData);
}

// 支出カテゴリデータ取得
function getExpenseCategoryData(element) {
    if (element.classList.contains('expense-category-card')) {
        const categoryName = element.querySelector('.expense-category-name')?.textContent;
        const categoryIcon = element.querySelector('.expense-category-icon i')?.textContent;
        
        console.log('Getting expense category data for:', categoryName);
        console.log('Available expense categories:', expenseCategories);
        console.log('Type of expenseCategories:', typeof expenseCategories);
        console.log('Is array?', Array.isArray(expenseCategories));
        
        // 既知のカテゴリマッピング（フォールバック用）
        const categoryMapping = {
            '食費': { id: 1, name: '食費', icon: 'restaurant' },
            '住居費': { id: 2, name: '住居費', icon: 'home' },
            '交通費': { id: 3, name: '交通費', icon: 'directions_car' },
            '日用品': { id: 4, name: '日用品', icon: 'shopping_cart' },
            '教育費': { id: 5, name: '教育費', icon: 'school' },
            '医療費': { id: 6, name: '医療費', icon: 'local_hospital' },
            '娯楽費': { id: 7, name: '娯楽費', icon: 'sports_esports' },
            '衣服費': { id: 8, name: '衣服費', icon: 'checkroom' },
            'その他': { id: 9, name: 'その他', icon: 'category' }
        };
        
        // expenseCategoriesが配列であることを確認
        if (Array.isArray(expenseCategories) && expenseCategories.length > 0) {
            const category = expenseCategories.find(cat => cat.name === categoryName);
            
            if (category) {
                console.log('Found category:', category);
                return category;
            }
        }
        
        // マッピングから探す
        if (categoryMapping[categoryName]) {
            console.log('Found category in mapping:', categoryMapping[categoryName]);
            return categoryMapping[categoryName];
        }
        
        // カテゴリが見つからない場合の最終フォールバック
        console.log('Category not found, using final fallback');
        return {
            id: 1, // デフォルトカテゴリID
            name: categoryName || '支出',
            icon: categoryIcon || 'category'
        };
    }
    return null;
}

// 家計簿登録モーダル表示
function showHouseholdEntryModal(accountData, categoryData) {
    const modal = document.getElementById('householdEntryModal');
    
    // フォーム要素設定
    const sourceAccountIdElement = document.getElementById('sourceAccountId');
    const expenseCategoryIdElement = document.getElementById('expenseCategoryId');
    const entryYearElement = document.getElementById('entryYear');
    const entryMonthElement = document.getElementById('entryMonth');
    const sourceAccountDisplayElement = document.getElementById('sourceAccountDisplay');
    const sourceAccountNameElement = document.getElementById('sourceAccountName');
    const targetCategoryDisplayElement = document.getElementById('targetCategoryDisplay');
    const targetCategoryNameElement = document.getElementById('targetCategoryName');
    const householdDateElement = document.getElementById('householdDate');
    const householdAmountElement = document.getElementById('householdAmount');
    const householdDescriptionElement = document.getElementById('householdDescription');
    
    // 要素の存在チェック
    if (!sourceAccountIdElement || !expenseCategoryIdElement || !entryYearElement || !entryMonthElement ||
        !sourceAccountDisplayElement || !sourceAccountNameElement || !targetCategoryDisplayElement || 
        !targetCategoryNameElement || !householdDateElement || !householdAmountElement || !householdDescriptionElement) {
        console.error('Required modal elements not found');
        showToast('モーダルの初期化に失敗しました', 'error');
        return;
    }
    
    // フォーム要素設定
    sourceAccountIdElement.value = accountData.id;
    expenseCategoryIdElement.value = categoryData.id;
    
    // 現在の年月を設定
    const now = new Date();
    entryYearElement.value = now.getFullYear();
    entryMonthElement.value = now.getMonth() + 1;
    
    // 表示情報設定
    sourceAccountDisplayElement.innerHTML = `
        <i class="material-icons" style="color: ${accountData.color}">${accountData.icon}</i>
        <span>${accountData.name}</span>
    `;
    sourceAccountNameElement.textContent = accountData.name;
    
    targetCategoryDisplayElement.innerHTML = `
        <i class="material-icons">${categoryData.icon}</i>
        <span>${categoryData.name}</span>
    `;
    targetCategoryNameElement.textContent = categoryData.name;
    
    // 日付を今日に設定
    const today = new Date().toISOString().split('T')[0];
    householdDateElement.value = today;
    
    // フォームリセット
    householdAmountElement.value = '';
    householdDescriptionElement.value = '';
    
    // モーダル表示
    modal.style.display = 'block';
}

// 家計簿登録モーダル閉じる
function closeHouseholdEntryModal() {
    const modal = document.getElementById('householdEntryModal');
    modal.style.display = 'none';
}

function showEditAccountModal(account) {
    editingAccountId = account.id;
    document.getElementById('edit-account-name').value = account.name;
    document.getElementById('edit-account-description').value = account.description || '';
    // アイコン選択肢を新規作成と同じ5種類に統一
    const icons = ["account_balance", "account_balance_wallet", "credit_card", "savings", "trending_up"];
    const iconSelector = document.getElementById('edit-icon-selector');
    iconSelector.innerHTML = icons.map(icon =>
        `<span class="icon-option${account.icon === icon ? ' selected' : ''}" data-icon="${icon}"><i class="material-icons">${icon}</i></span>`
    ).join('');
    iconSelector.querySelectorAll('.icon-option').forEach(opt => {
        opt.onclick = function() {
            iconSelector.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
    // カラー選択肢
    const colors = ["#2196F3", "#4CAF50", "#FF9800", "#9C27B0", "#F44336", "#607D8B"];
    const colorSelector = document.getElementById('edit-color-selector');
    colorSelector.innerHTML = colors.map(color =>
        `<span class="color-option${account.color === color ? ' selected' : ''}" data-color="${color}" style="background:${color}"></span>`
    ).join('');
    colorSelector.querySelectorAll('.color-option').forEach(opt => {
        opt.onclick = function() {
            colorSelector.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
    document.getElementById('edit-account-modal').style.display = 'block';
}

function hideEditAccountModal() {
    document.getElementById('edit-account-modal').style.display = 'none';
    editingAccountId = null;
}

document.getElementById('edit-account-btn').onclick = async function() {
    const name = document.getElementById('edit-account-name').value.trim();
    const description = document.getElementById('edit-account-description').value.trim();
    const icon = document.querySelector('#edit-icon-selector .icon-option.selected')?.dataset.icon || 'account_balance';
    const color = document.querySelector('#edit-color-selector .color-option.selected')?.dataset.color || '#2196F3';
    if (!name) {
        showToast('口座名を入力してください', 'error');
        return;
    }
    // APIリクエスト
    const res = await fetch(`/api/accounts/${editingAccountId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, icon, color })
    });
    const data = await res.json();
    if (data.success) {
        showToast('変更が完了しました', 'success');
        hideEditAccountModal();
        loadAccounts();
    } else {
        showToast('変更に失敗しました', 'error');
    }
};

// 選択UIの初期化
function initializeSelectionUI() {
    window.selectionUI = new SelectionUI({
        onCopy: null, // アカウント管理ではコピー機能は不要
        onDelete: handleDelete,
        onEdit: handleEdit,
        onCancel: handleCancel,
        getItemId: (element) => element.dataset.accountId
    });
}

// 削除処理
async function handleDelete(selectedIds) {
    const confirmMessage = `選択した${selectedIds.length}件の口座を削除しますか？`;
    if (!confirm(confirmMessage)) return;
    
    try {
        let successCount = 0;
        
        for (const id of selectedIds) {
            const response = await fetch(`/api/accounts/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) successCount++;
        }
        
        if (successCount > 0) {
            showToast(`${successCount}件の口座を削除しました`, 'success');
            loadAccounts();
        } else {
            showToast('口座の削除に失敗しました', 'error');
        }
    } catch (error) {
        console.error('Error deleting accounts:', error);
        showToast('口座の削除中にエラーが発生しました', 'error');
    }
}

// 編集処理
async function handleEdit(accountId) {
    const account = accounts.find(acc => acc.id === parseInt(accountId));
    if (account) {
        showEditAccountModal(account);
    }
}

// キャンセル処理
function handleCancel() {
    // 選択モード終了時の処理
    console.log('Selection mode cancelled');
}
</script>
{% endblock %} 